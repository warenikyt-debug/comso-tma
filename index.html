<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PAC-MAN: ZOMBIE PSYCHO EDITION</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            user-select: none;
            font-family: 'Comic Sans MS', 'Wingdings', 'Papyrus', cursive;
        }

        body {
            background: #000;
            color: #FF00FF;
            overflow: hidden;
            cursor: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32"><circle cx="16" cy="16" r="15" fill="lime"/><text x="8" y="24" font-size="16">üëÅÔ∏è</text></svg>'), auto;
        }

        #gameContainer {
            width: 100vw;
            height: 100vh;
            position: relative;
            background: #000;
            overflow: hidden;
        }

        #gameCanvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        #hud {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 100;
            background: rgba(0, 0, 0, 0.8);
            padding: 20px 30px;
            border-radius: 20px;
            border: 5px dashed #00FFFF;
            box-shadow: 0 0 30px #FF00FF;
            transform: rotate(-2deg);
        }

        #score {
            font-size: 36px;
            color: #FFFF00;
            text-shadow: 0 0 15px #FF0000, 0 0 30px #FF4500;
            margin-bottom: 10px;
            animation: scorePulse 1s infinite;
        }

        @keyframes scorePulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        #lives {
            font-size: 28px;
            color: #00FF00;
            text-shadow: 0 0 10px #00FF00;
        }

        #level {
            font-size: 24px;
            color: #FF00FF;
            margin-top: 10px;
            text-shadow: 0 0 10px #FF00FF;
        }

        #rageMeter {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            padding: 20px 30px;
            border-radius: 20px;
            border: 5px dotted #FF0000;
            z-index: 100;
            transform: rotate(2deg);
        }

        #rageText {
            font-size: 24px;
            color: #FF0000;
            margin-bottom: 10px;
            text-shadow: 0 0 10px #FF0000;
        }

        #rageBar {
            width: 200px;
            height: 30px;
            background: #333;
            border-radius: 15px;
            overflow: hidden;
            border: 3px solid #FF4500;
        }

        #rageFill {
            height: 100%;
            background: linear-gradient(90deg, #00FF00, #FFFF00, #FF0000);
            width: 0%;
            transition: width 0.5s;
        }

        #gameOver {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.95);
            padding: 60px;
            border-radius: 50px;
            border: 10px solid #FF0000;
            text-align: center;
            z-index: 200;
            display: none;
            width: 90%;
            max-width: 600px;
            box-shadow: 0 0 100px #FF0000;
            animation: gameOverShake 0.5s infinite;
        }

        @keyframes gameOverShake {
            0%, 100% { transform: translate(-50%, -50%) rotate(0deg); }
            25% { transform: translate(-50%, -50%) rotate(5deg); }
            50% { transform: translate(-50%, -50%) rotate(-5deg); }
            75% { transform: translate(-50%, -50%) rotate(5deg); }
        }

        #gameOver h1 {
            font-size: 72px;
            color: #FF0000;
            margin-bottom: 30px;
            text-shadow: 0 0 30px #FF0000;
        }

        #finalScore {
            font-size: 80px;
            color: #FFFF00;
            margin: 40px 0;
            text-shadow: 0 0 20px #FFFF00;
            animation: finalScoreSpin 3s infinite linear;
        }

        @keyframes finalScoreSpin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        #restartBtn {
            background: linear-gradient(45deg, #FF00FF, #00FFFF);
            color: black;
            border: none;
            padding: 25px 60px;
            font-size: 32px;
            border-radius: 50px;
            cursor: pointer;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 3px;
            transition: all 0.3s;
            box-shadow: 0 0 50px #FF00FF;
        }

        #restartBtn:hover {
            transform: scale(1.2) rotate(10deg);
            box-shadow: 0 0 80px #00FFFF;
        }

        #startScreen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, #000000 0%, #330033 100%);
            z-index: 300;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 20px;
        }

        #startScreen h1 {
            font-size: 96px;
            color: #FFFF00;
            text-shadow: 0 0 50px #FF0000, 0 0 100px #FF4500;
            margin-bottom: 40px;
            animation: titleFloat 3s infinite ease-in-out;
        }

        @keyframes titleFloat {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-30px); }
        }

        #startScreen h2 {
            color: #00FFFF;
            font-size: 48px;
            margin-bottom: 40px;
            text-shadow: 0 0 30px #00FFFF;
            transform: rotate(-5deg);
        }

        .crazy-rules {
            background: rgba(255, 0, 255, 0.2);
            padding: 30px;
            border-radius: 30px;
            border: 5px solid #00FF00;
            max-width: 800px;
            margin: 30px 0;
            transform: rotate(3deg);
        }

        .crazy-rules h3 {
            color: #FF0000;
            font-size: 36px;
            margin-bottom: 20px;
            text-shadow: 0 0 15px #FF0000;
        }

        .crazy-rules p {
            color: #FFFFFF;
            font-size: 20px;
            margin: 15px 0;
            text-align: left;
            padding-left: 20px;
        }

        #startBtn {
            background: linear-gradient(45deg, #FF0000, #00FF00, #0000FF);
            color: white;
            border: none;
            padding: 30px 80px;
            font-size: 40px;
            border-radius: 100px;
            cursor: pointer;
            margin-top: 50px;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 5px;
            box-shadow: 0 0 100px rgba(255, 0, 0, 0.7);
            transition: all 0.3s;
            animation: startBtnPulse 2s infinite;
        }

        @keyframes startBtnPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        #startBtn:hover {
            transform: scale(1.3) rotate(180deg);
            box-shadow: 0 0 150px rgba(0, 255, 0, 1);
        }

        .controls {
            position: absolute;
            bottom: 40px;
            left: 0;
            right: 0;
            display: flex;
            justify-content: center;
            gap: 30px;
            z-index: 100;
        }

        .controlBtn {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            border: 6px solid #FFFF00;
            background: linear-gradient(45deg, #FF00FF, #FF4500);
            color: white;
            font-size: 40px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 0 40px #FF00FF;
            transition: all 0.1s;
            transform: rotate(45deg);
        }

        .controlBtn:active {
            transform: scale(0.8) rotate(135deg);
            background: linear-gradient(45deg, #00FFFF, #00FF00);
        }

        #powerBtn {
            position: absolute;
            bottom: 40px;
            right: 40px;
            background: linear-gradient(45deg, #00FF00, #008000);
            border-color: #00FF00;
            transform: rotate(-45deg);
        }

        .crazy-message {
            position: absolute;
            color: #FFFF00;
            font-size: 32px;
            text-shadow: 0 0 20px #FF0000;
            z-index: 150;
            pointer-events: none;
            animation: crazyFloat 3s forwards;
            text-align: center;
        }

        @keyframes crazyFloat {
            0% { transform: translateY(0) rotate(0deg); opacity: 1; }
            100% { transform: translateY(-200px) rotate(360deg); opacity: 0; }
        }

        .teleport-effect {
            position: absolute;
            width: 100px;
            height: 100px;
            border: 10px dotted #00FFFF;
            border-radius: 50%;
            animation: teleportSpin 1s infinite linear;
            pointer-events: none;
            z-index: 50;
        }

        @keyframes teleportSpin {
            0% { transform: scale(0.5) rotate(0deg); opacity: 1; }
            100% { transform: scale(2) rotate(360deg); opacity: 0; }
        }

        .insanity-level {
            position: absolute;
            bottom: 20px;
            left: 20px;
            font-size: 24px;
            color: #FF00FF;
            background: rgba(0, 0, 0, 0.7);
            padding: 15px;
            border-radius: 15px;
            border: 3px solid #FF00FF;
        }

        #mapIndicator {
            position: absolute;
            top: 150px;
            right: 20px;
            width: 200px;
            height: 200px;
            background: rgba(0, 0, 0, 0.7);
            border: 5px solid #00FFFF;
            border-radius: 50%;
            z-index: 90;
            pointer-events: none;
            overflow: hidden;
        }

        @media (max-width: 768px) {
            .controlBtn {
                width: 80px;
                height: 80px;
                font-size: 30px;
            }
            
            #startScreen h1 {
                font-size: 48px;
            }
            
            #startScreen h2 {
                font-size: 24px;
            }
            
            .crazy-rules {
                padding: 15px;
                font-size: 14px;
            }
        }
    </style>
</head>
<body>
    <div id="gameContainer">
        <canvas id="gameCanvas"></canvas>
        
        <div id="hud">
            <div id="score">–°–ß–Å–¢: 0</div>
            <div id="lives">–ñ–ò–ó–ù–ò: ‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</div>
            <div id="level">–£–†–û–í–ï–ù–¨ –ë–ï–ó–£–ú–ò–Ø: 1</div>
        </div>
        
        <div id="rageMeter">
            <div id="rageText">‚ö° –®–ö–ê–õ–ê –Ø–†–û–°–¢–ò ‚ö°</div>
            <div id="rageBar">
                <div id="rageFill"></div>
            </div>
        </div>
        
        <div id="mapIndicator"></div>
        
        <div class="insanity-level" id="insanityLevel">–ë–ï–ó–£–ú–ò–ï: 0%</div>
        
        <div id="gameOver">
            <h1>–í–ê–® –ú–û–ù–ò–¢–û–† –°–õ–û–ú–ê–ù</h1>
            <div style="color: #AAA; font-size: 24px; margin-bottom: 30px;">
                –í—ã –¥–æ—Å—Ç–∏–≥–ª–∏ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–≥–æ —É—Ä–æ–≤–Ω—è —è—Ä–æ—Å—Ç–∏ –∏ —Å–ª–æ–º–∞–ª–∏ —ç–∫—Ä–∞–Ω!
            </div>
            <div id="finalScore">0</div>
            <div style="color: #00FF00; margin: 30px 0; font-size: 28px;">
                –£—Ä–æ–≤–µ–Ω—å –±–µ–∑—É–º–∏—è: <span id="finalInsanity">0%</span>
            </div>
            <button id="restartBtn">–°–õ–û–ú–ê–¢–¨ –ï–©–Å –†–ê–ó</button>
        </div>
        
        <div id="startScreen">
            <h1>PAC-MAN</h1>
            <h2>PSYCHO ZOMBIE EDITION</h2>
            
            <div class="crazy-rules">
                <h3>‚ö†Ô∏è –ü–†–ê–í–ò–õ–ê, –ö–û–¢–û–†–´–• –ù–ï–¢:</h3>
                <p>‚Ä¢ üü° –ï—à—å —Ç–æ—á–∫–∏, –Ω–æ –æ–Ω–∏ –∏–Ω–æ–≥–¥–∞ –∫—É—Å–∞—é—Ç—Å—è</p>
                <p>‚Ä¢ üëª –£–±–µ–≥–∞–π –æ—Ç –ø—Ä–∏–∑—Ä–∞–∫–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ —Ç–µ–ª–µ–ø–æ—Ä—Ç–∏—Ä—É—é—Ç—Å—è</p>
                <p>‚Ä¢ üíÄ –ò–∑–±–µ–≥–∞–π –∑–æ–º–±–∏-—à–∞—Ä–æ–≤, –æ–Ω–∏ –æ—Ç—Å–∫–∞–∫–∏–≤–∞—é—Ç –Ω–µ–ª–æ–≥–∏—á–Ω–æ</p>
                <p>‚Ä¢ üöÄ –õ–µ—Ç–∞—é—â–∏–µ —Ç–∞—Ä–µ–ª–∫–∏ –º–µ–Ω—è—é—Ç –≥—Ä–∞–≤–∏—Ç–∞—Ü–∏—é</p>
                <p>‚Ä¢ üîÑ –ü–æ—Ä—Ç–∞–ª—ã –≤–µ–¥—É—Ç –≤ —Å–ª—É—á–∞–π–Ω—ã–µ –º–µ—Å—Ç–∞</p>
                <p>‚Ä¢ ‚ö° –≠–Ω–µ—Ä–¥–∂–∞–π–∑–µ—Ä—ã –¥–µ–ª–∞—é—Ç –≤—Å—ë –Ω–∞–æ–±–æ—Ä–æ—Ç</p>
                <p>‚Ä¢ ü§Ø –ß–µ–º –≤—ã—à–µ —É—Ä–æ–≤–µ–Ω—å, —Ç–µ–º –±–µ–∑—É–º–Ω–µ–µ —Ñ–∏–∑–∏–∫–∞</p>
                <p>‚Ä¢ üí¢ –®–∫–∞–ª–∞ —è—Ä–æ—Å—Ç–∏: –∫–æ–≥–¥–∞ –∑–∞–ø–æ–ª–Ω–∏—Ç—Å—è - –∏–≥—Ä–∞ —Å–ª–æ–º–∞–µ—Ç—Å—è</p>
            </div>
            
            <button id="startBtn">–ù–ê–ß–ê–¢–¨ –ë–ï–ó–£–ú–ò–ï</button>
        </div>
        
        <div class="controls">
            <button class="controlBtn" id="upBtn">‚Üë</button>
            <button class="controlBtn" id="leftBtn">‚Üê</button>
            <button class="controlBtn" id="downBtn">‚Üì</button>
            <button class="controlBtn" id="rightBtn">‚Üí</button>
        </div>
        
        <button class="controlBtn" id="powerBtn">‚ö°</button>
    </div>

    <script>
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram
        if (typeof Telegram !== 'undefined') {
            Telegram.WebApp.ready();
            Telegram.WebApp.expand();
            Telegram.WebApp.setHeaderColor('#000');
            Telegram.WebApp.setBackgroundColor('#000');
        }

        // –ü–æ–ª—É—á–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const scoreElement = document.getElementById('score');
        const livesElement = document.getElementById('lives');
        const levelElement = document.getElementById('level');
        const rageFill = document.getElementById('rageFill');
        const gameOverScreen = document.getElementById('gameOver');
        const finalScoreElement = document.getElementById('finalScore');
        const finalInsanityElement = document.getElementById('finalInsanity');
        const restartBtn = document.getElementById('restartBtn');
        const startScreen = document.getElementById('startScreen');
        const startBtn = document.getElementById('startBtn');
        const upBtn = document.getElementById('upBtn');
        const leftBtn = document.getElementById('leftBtn');
        const downBtn = document.getElementById('downBtn');
        const rightBtn = document.getElementById('rightBtn');
        const powerBtn = document.getElementById('powerBtn');
        const insanityLevel = document.getElementById('insanityLevel');
        const mapIndicator = document.getElementById('mapIndicator');
        const mapCtx = mapIndicator.getContext('2d');

        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ canvas
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        mapIndicator.width = 200;
        mapIndicator.height = 200;

        // –û–ì–†–û–ú–ù–ê–Ø –ö–ê–†–¢–ê (100x100 –∫–ª–µ—Ç–æ–∫!)
        const MAP_SIZE = 100;
        const CELL_SIZE = 60;
        const GRID_WIDTH = MAP_SIZE * CELL_SIZE;
        const GRID_HEIGHT = MAP_SIZE * CELL_SIZE;

        // –ò–≥—Ä–æ–≤—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        let game = {
            running: false,
            score: 0,
            lives: 3,
            level: 1,
            rage: 0,
            insanity: 0,
            gameOver: false,
            powerMode: false,
            powerTimer: 0,
            cameraX: 0,
            cameraY: 0,
            teleporting: false,
            gravityReversed: false,
            controlsReversed: false,
            lastCrazyEvent: 0,
            dotsCollected: 0,
            totalDots: 0,
            map: []
        };

        // –ü–∞–∫–º–∞–Ω
        const pacman = {
            x: MAP_SIZE * CELL_SIZE / 2,
            y: MAP_SIZE * CELL_SIZE / 2,
            radius: 25,
            speed: 5,
            direction: { x: 0, y: 0 },
            mouthAngle: 0.2,
            mouthSpeed: 0.1,
            color: '#FFFF00',
            trail: [],
            invincible: false,
            invincibleTimer: 0
        };

        // –û–±—ä–µ–∫—Ç—ã –∏–≥—Ä—ã
        let dots = [];
        let energizers = [];
        let ghosts = [];
        let zombies = [];
        let ufos = [];
        let portals = [];
        let powerUps = [];
        let particles = [];
        let crazyMessages = [];

        // –°–ª—É—á–∞–π–Ω—ã–µ –±–µ–∑—É–º–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
        const CRAZY_MESSAGES = [
            "–ì–î–Ø –Ø?!! ü§™",
            "–í–°–Å –ù–ï –¢–ê–ö! üîÑ",
            "–ü–û–ß–ï–ú–£ –û–ù–ò –¢–ï–õ–ï–ü–û–†–¢–ò–†–£–Æ–¢–°–Ø? üåÄ",
            "–≠–¢–û –ù–ï–õ–û–ì–ò–ß–ù–û! ü§Ø",
            "–ì–†–ê–í–ò–¢–ê–¶–ò–Ø –°–õ–û–ú–ê–ù–ê! üåç",
            "–Ø –î–û–õ–ñ–ï–ù –ò–î–¢–ò –í–í–ï–†–•? –í–ù–ò–ó? ü§î",
            "–ü–†–ò–ó–†–ê–ö–ò –í –ú–û–ò–• –°–¢–ï–ù–ê–•! üëª",
            "–ó–û–ú–ë–ò-–®–ê–†–´ –ù–ï –û–¢–°–ö–ê–ö–ò–í–ê–Æ–¢! üíÄ",
            "–õ–ï–¢–ê–Æ–©–ò–ï –¢–ê–†–ï–õ–ö–ò! üõ∏",
            "–ü–û–†–¢–ê–õ–´ –í–ï–ó–î–ï! üåÄ",
            "–£–ü–†–ê–í–õ–ï–ù–ò–ï –ò–ù–í–ï–†–¢–ò–†–û–í–ê–ù–û! ‚Ü©Ô∏è",
            "–≠–ö–†–ê–ù –î–†–û–ñ–ò–¢! üì∫",
            "–¶–í–ï–¢–ê –ú–ï–ù–Ø–Æ–¢–°–Ø! üé®",
            "–ó–í–£–ö–ò –ò–ó –ù–ò–û–¢–ö–£–î–ê! üîä",
            "–ú–û–ô –ö–£–†–°–û–† –ñ–ò–í–û–ô! üê≠",
            "–í–†–ï–ú–Ø –ó–ê–ú–ï–î–õ–ò–õ–û–°–¨! ‚è≥",
            "–í–°–Å –£–°–ö–û–†–ò–õ–û–°–¨! ‚ö°",
            "–ö–ê–†–¢–ê –í–†–ê–©–ê–ï–¢–°–Ø! üó∫Ô∏è",
            "–Ø –í –ú–ê–¢–†–ò–¶–ï? üíä",
            "–°–õ–û–ú–ê–ô –≠–ö–†–ê–ù! üí¢"
        ];

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç—ã
        function initMap() {
            game.map = [];
            dots = [];
            energizers = [];
            portals = [];
            
            // –°–æ–∑–¥–∞–µ–º –ª–∞–±–∏—Ä–∏–Ω—Ç —Å –Ω–µ–ª–æ–≥–∏—á–Ω—ã–º–∏ –ø—Ä–æ—Ö–æ–¥–∞–º–∏
            for (let y = 0; y < MAP_SIZE; y++) {
                game.map[y] = [];
                for (let x = 0; x < MAP_SIZE; x++) {
                    // –°–ª—É—á–∞–π–Ω—ã–µ —Å—Ç–µ–Ω—ã (60% –ø—Ä–æ—Ö–æ–¥–∏–º—ã—Ö –∫–ª–µ—Ç–æ–∫)
                    const isWall = Math.random() > 0.6;
                    game.map[y][x] = isWall ? 1 : 0;
                    
                    // –¢–æ—á–∫–∏ –≤ –ø—Ä–æ—Ö–æ–¥–∏–º—ã—Ö –∫–ª–µ—Ç–∫–∞—Ö (80% –∫–ª–µ—Ç–æ–∫)
                    if (!isWall && Math.random() > 0.2) {
                        dots.push({
                            x: x * CELL_SIZE + CELL_SIZE / 2,
                            y: y * CELL_SIZE + CELL_SIZE / 2,
                            radius: 8,
                            color: '#FFFF00',
                            collected: false,
                            blinking: Math.random() > 0.5
                        });
                    }
                    
                    // –≠–Ω–µ—Ä–¥–∂–∞–π–∑–µ—Ä—ã (1% –∫–ª–µ—Ç–æ–∫)
                    if (!isWall && Math.random() > 0.99) {
                        energizers.push({
                            x: x * CELL_SIZE + CELL_SIZE / 2,
                            y: y * CELL_SIZE + CELL_SIZE / 2,
                            radius: 15,
                            color: '#00FFFF',
                            collected: false,
                            pulse: 0
                        });
                    }
                    
                    // –ü–æ—Ä—Ç–∞–ª (0.5% –∫–ª–µ—Ç–æ–∫)
                    if (!isWall && Math.random() > 0.995) {
                        portals.push({
                            x: x * CELL_SIZE + CELL_SIZE / 2,
                            y: y * CELL_SIZE + CELL_SIZE / 2,
                            radius: 30,
                            color: '#FF00FF',
                            linkedTo: null,
                            active: true
                        });
                    }
                }
            }
            
            // –°–≤—è–∑—ã–≤–∞–µ–º –ø–æ—Ä—Ç–∞–ª—ã –ø–æ–ø–∞—Ä–Ω–æ
            for (let i = 0; i < portals.length; i += 2) {
                if (portals[i + 1]) {
                    portals[i].linkedTo = portals[i + 1];
                    portals[i + 1].linkedTo = portals[i];
                }
            }
            
            game.totalDots = dots.length;
            
            // –°–æ–∑–¥–∞–µ–º –≤—Ä–∞–≥–æ–≤
            createGhosts();
            createZombies();
            createUFOs();
            createPowerUps();
        }

        // –°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–∏–∑—Ä–∞–∫–æ–≤
        function createGhosts() {
            ghosts = [];
            const ghostTypes = [
                { color: '#FF0000', name: '–ë–õ–ò–ù–ö–ò', speed: 3, behavior: 'chase' },
                { color: '#FF69B4', name: '–ü–ò–ù–ö–ò', speed: 2.5, behavior: 'ambush' },
                { color: '#00FFFF', name: '–ò–ù–ö–ò', speed: 2, behavior: 'random' },
                { color: '#FFA500', name: '–ö–õ–ê–ô–î', speed: 3.5, behavior: 'scatter' }
            ];
            
            for (let i = 0; i < 8 + game.level * 2; i++) {
                const type = ghostTypes[Math.floor(Math.random() * ghostTypes.length)];
                ghosts.push({
                    x: Math.random() * GRID_WIDTH,
                    y: Math.random() * GRID_HEIGHT,
                    radius: 20,
                    color: type.color,
                    speed: type.speed + Math.random() * 2,
                    direction: { x: 0, y: 0 },
                    target: { x: 0, y: 0 },
                    behavior: type.behavior,
                    scared: false,
                    scaredTimer: 0,
                    teleportCooldown: 0,
                    name: type.name,
                    eyes: Math.random() > 0.5
                });
            }
        }

        // –°–æ–∑–¥–∞–Ω–∏–µ –∑–æ–º–±–∏-—à–∞—Ä–æ–≤
        function createZombies() {
            zombies = [];
            for (let i = 0; i < 5 + game.level; i++) {
                zombies.push({
                    x: Math.random() * GRID_WIDTH,
                    y: Math.random() * GRID_HEIGHT,
                    radius: 30 + Math.random() * 20,
                    color: '#00FF00',
                    speed: 2 + Math.random() * 3,
                    direction: {
                        x: Math.random() * 2 - 1,
                        y: Math.random() * 2 - 1
                    },
                    bounceCount: 0,
                    rotation: 0,
                    face: Math.random() > 0.5 ? 'üßü' : 'üíÄ'
                });
            }
        }

        // –°–æ–∑–¥–∞–Ω–∏–µ –ª–µ—Ç–∞—é—â–∏—Ö —Ç–∞—Ä–µ–ª–æ–∫
        function createUFOs() {
            ufos = [];
            for (let i = 0; i < 3 + Math.floor(game.level / 2); i++) {
                ufos.push({
                    x: Math.random() * GRID_WIDTH,
                    y: Math.random() * GRID_HEIGHT,
                    radius: 40,
                    color: '#FF00FF',
                    speed: 1 + Math.random() * 2,
                    direction: { x: 1, y: 0 },
                    beamActive: false,
                    beamTimer: 0,
                    abductionTarget: null,
                    rotation: 0,
                    gravityField: 100
                });
            }
        }

        // –°–æ–∑–¥–∞–Ω–∏–µ –ø–∞–≤–µ—Ä-–∞–ø–æ–≤
        function createPowerUps() {
            powerUps = [];
            const powerTypes = [
                { type: 'speed', color: '#00FF00', symbol: '‚ö°', duration: 300 },
                { type: 'invincible', color: '#FFFF00', symbol: 'üõ°Ô∏è', duration: 200 },
                { type: 'magnet', color: '#FF0000', symbol: 'üß≤', duration: 400 },
                { type: 'confuse', color: '#FF00FF', symbol: 'üåÄ', duration: 250 },
                { type: 'time', color: '#00FFFF', symbol: '‚è≥', duration: 350 }
            ];
            
            for (let i = 0; i < 5; i++) {
                const power = powerTypes[Math.floor(Math.random() * powerTypes.length)];
                powerUps.push({
                    x: Math.random() * GRID_WIDTH,
                    y: Math.random() * GRID_HEIGHT,
                    radius: 20,
                    color: power.color,
                    type: power.type,
                    symbol: power.symbol,
                    duration: power.duration,
                    collected: false,
                    rotation: 0
                });
            }
        }

        // –ö–ª–∞—Å—Å –¥–ª—è —á–∞—Å—Ç–∏—Ü
        class Particle {
            constructor(x, y, color) {
                this.x = x;
                this.y = y;
                this.size = Math.random() * 10 + 2;
                this.speedX = Math.random() * 6 - 3;
                this.speedY = Math.random() * 6 - 3;
                this.color = color;
                this.life = 50;
                this.gravity = game.gravityReversed ? -0.1 : 0.1;
            }

            update() {
                this.x += this.speedX;
                this.y += this.speedY;
                this.speedY += this.gravity;
                this.life--;
                return this.life > 0;
            }

            draw() {
                ctx.save();
                ctx.globalAlpha = this.life / 50;
                ctx.fillStyle = this.color;
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
                ctx.fill();
                ctx.restore();
            }
        }

        // –§—É–Ω–∫—Ü–∏–∏ –∏–≥—Ä—ã
        function updatePacman() {
            // –ü—Ä–∏–º–µ–Ω—è–µ–º –∏–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
            let dirX = pacman.direction.x;
            let dirY = pacman.direction.y;
            
            if (game.controlsReversed) {
                dirX = -dirX;
                dirY = -dirY;
            }
            
            // –î–≤–∏–∂–µ–Ω–∏–µ —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π —Å—Ç–µ–Ω
            let newX = pacman.x + dirX * pacman.speed;
            let newY = pacman.y + dirY * pacman.speed;
            
            // –¢–µ–ª–µ–ø–æ—Ä—Ç–∞—Ü–∏—è —á–µ—Ä–µ–∑ –∫—Ä–∞—è –∫–∞—Ä—Ç—ã
            if (newX < 0) newX = GRID_WIDTH;
            if (newX > GRID_WIDTH) newX = 0;
            if (newY < 0) newY = GRID_HEIGHT;
            if (newY > GRID_HEIGHT) newY = 0;
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–æ–ª–∫–Ω–æ–≤–µ–Ω–∏—è —Å–æ —Å—Ç–µ–Ω–∞–º–∏ (–∏–Ω–æ–≥–¥–∞ –ø—Ä–æ—Ö–æ–¥–∏—Ç —Å–∫–≤–æ–∑—å)
            const gridX = Math.floor(newX / CELL_SIZE);
            const gridY = Math.floor(newY / CELL_SIZE);
            
            if (gridX >= 0 && gridX < MAP_SIZE && gridY >= 0 && gridY < MAP_SIZE) {
                if (game.map[gridY][gridX] === 0 || Math.random() > 0.7) { // 30% —à–∞–Ω—Å –ø—Ä–æ–π—Ç–∏ —Å–∫–≤–æ–∑—å —Å—Ç–µ–Ω—É
                    pacman.x = newX;
                    pacman.y = newY;
                }
            }
            
            // –ê–Ω–∏–º–∞—Ü–∏—è —Ä—Ç–∞
            pacman.mouthAngle += pacman.mouthSpeed;
            if (pacman.mouthAngle > 0.8 || pacman.mouthAngle < 0.2) {
                pacman.mouthSpeed = -pacman.mouthSpeed;
            }
            
            // –°–ª–µ–¥
            pacman.trail.push({ x: pacman.x, y: pacman.y });
            if (pacman.trail.length > 20) {
                pacman.trail.shift();
            }
            
            // –ù–µ—É—è–∑–≤–∏–º–æ—Å—Ç—å
            if (pacman.invincible) {
                pacman.invincibleTimer--;
                if (pacman.invincibleTimer <= 0) {
                    pacman.invincible = false;
                }
            }
            
            // –°–±–æ—Ä —Ç–æ—á–µ–∫
            dots.forEach(dot => {
                if (!dot.collected) {
                    const dx = pacman.x - dot.x;
                    const dy = pacman.y - dot.y;
                    const distance = Math.sqrt(dx * dx + dy * dy);
                    
                    if (distance < pacman.radius + dot.radius) {
                        dot.collected = true;
                        game.score += 10;
                        game.dotsCollected++;
                        
                        // –ò–Ω–æ–≥–¥–∞ —Ç–æ—á–∫–∞ "–∫—É—Å–∞–µ—Ç—Å—è"
                        if (Math.random() > 0.9) {
                            takeDamage(1);
                            showCrazyMessage("–¢–û–ß–ö–ê –£–ö–£–°–ò–õ–ê! üò±", pacman.x, pacman.y);
                        }
                        
                        // –°–æ–∑–¥–∞–µ–º —á–∞—Å—Ç–∏—Ü—ã
                        for (let i = 0; i < 5; i++) {
                            particles.push(new Particle(dot.x, dot.y, dot.color));
                        }
                    }
                }
            });
            
            // –°–±–æ—Ä —ç–Ω–µ—Ä–¥–∂–∞–π–∑–µ—Ä–æ–≤
            energizers.forEach(energizer => {
                if (!energizer.collected) {
                    const dx = pacman.x - energizer.x;
                    const dy = pacman.y - energizer.y;
                    const distance = Math.sqrt(dx * dx + dy * dy);
                    
                    if (distance < pacman.radius + energizer.radius) {
                        energizer.collected = true;
                        game.score += 50;
                        game.powerMode = true;
                        game.powerTimer = 300;
                        
                        // –≠–Ω–µ—Ä–¥–∂–∞–π–∑–µ—Ä –¥–µ–ª–∞–µ—Ç —á—Ç–æ-—Ç–æ –±–µ–∑—É–º–Ω–æ–µ
                        const effects = [
                            () => { game.gravityReversed = !game.gravityReversed; showCrazyMessage("–ì–†–ê–í–ò–¢–ê–¶–ò–Ø –ü–ï–†–ï–í–ï–†–ù–£–õ–ê–°–¨! üåç", pacman.x, pacman.y); },
                            () => { game.controlsReversed = !game.controlsReversed; showCrazyMessage("–£–ü–†–ê–í–õ–ï–ù–ò–ï –ò–ù–í–ï–†–¢–ò–†–û–í–ê–ù–û! ‚Ü©Ô∏è", pacman.x, pacman.y); },
                            () => { pacman.speed *= 2; setTimeout(() => pacman.speed /= 2, 5000); showCrazyMessage("–°–£–ü–ï–† –°–ö–û–†–û–°–¢–¨! ‚ö°", pacman.x, pacman.y); },
                            () => { teleportRandom(); showCrazyMessage("–¢–ï–õ–ï–ü–û–†–¢–ê–¶–ò–Ø! üåÄ", pacman.x, pacman.y); }
                        ];
                        
                        effects[Math.floor(Math.random() * effects.length)]();
                        
                        // –ß–∞—Å—Ç–∏—Ü—ã
                        for (let i = 0; i < 20; i++) {
                            particles.push(new Particle(energizer.x, energizer.y, energizer.color));
                        }
                    }
                }
            });
            
            // –ü–æ—Ä—Ç–∞–ª
            portals.forEach(portal => {
                if (portal.active) {
                    const dx = pacman.x - portal.x;
                    const dy = pacman.y - portal.y;
                    const distance = Math.sqrt(dx * dx + dy * dy);
                    
                    if (distance < pacman.radius + portal.radius && portal.linkedTo && !game.teleporting) {
                        game.teleporting = true;
                        const oldX = pacman.x;
                        const oldY = pacman.y;
                        
                        // –≠—Ñ—Ñ–µ–∫—Ç —Ç–µ–ª–µ–ø–æ—Ä—Ç–∞—Ü–∏–∏
                        createTeleportEffect(oldX, oldY);
                        
                        // –¢–µ–ª–µ–ø–æ—Ä—Ç–∞—Ü–∏—è
                        pacman.x = portal.linkedTo.x;
                        pacman.y = portal.linkedTo.y;
                        
                        // –°–ª—É—á–∞–π–Ω–æ–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ—Å–ª–µ —Ç–µ–ª–µ–ø–æ—Ä—Ç–∞—Ü–∏–∏
                        pacman.direction.x = Math.random() * 2 - 1;
                        pacman.direction.y = Math.random() * 2 - 1;
                        
                        createTeleportEffect(pacman.x, pacman.y);
                        showCrazyMessage("–ö–£–î–ê –Ø –ü–û–ü–ê–õ?! üåÄ", pacman.x, pacman.y);
                        
                        setTimeout(() => game.teleporting = false, 500);
                    }
                }
            });
            
            // –ü–∞–≤–µ—Ä-–∞–ø—ã
            powerUps.forEach(powerUp => {
                if (!powerUp.collected) {
                    const dx = pacman.x - powerUp.x;
                    const dy = pacman.y - powerUp.y;
                    const distance = Math.sqrt(dx * dx + dy * dy);
                    
                    if (distance < pacman.radius + powerUp.radius) {
                        powerUp.collected = true;
                        applyPowerUp(powerUp);
                    }
                }
            });
            
            // –†–µ–∂–∏–º —Å–∏–ª—ã
            if (game.powerMode) {
                game.powerTimer--;
                if (game.powerTimer <= 0) {
                    game.powerMode = false;
                }
            }
            
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–º–µ—Ä—ã
            game.cameraX = pacman.x - canvas.width / 2;
            game.cameraY = pacman.y - canvas.height / 2;
            
            // –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –∫–∞–º–µ—Ä—ã
            game.cameraX = Math.max(0, Math.min(game.cameraX, GRID_WIDTH - canvas.width));
            game.cameraY = Math.max(0, Math.min(game.cameraY, GRID_HEIGHT - canvas.height));
            
            // –£–≤–µ–ª–∏—á–µ–Ω–∏–µ –±–µ–∑—É–º–∏—è
            game.insanity = Math.min(100, game.insanity + 0.01);
            
            // –°–ª—É—á–∞–π–Ω—ã–µ –±–µ–∑—É–º–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è
            if (Date.now() - game.lastCrazyEvent > 10000 && Math.random() > 0.99) {
                triggerCrazyEvent();
                game.lastCrazyEvent = Date.now();
            }
        }

        function updateGhosts() {
            ghosts.forEach(ghost => {
                // –¢–µ–ª–µ–ø–æ—Ä—Ç–∞—Ü–∏—è –ø—Ä–∏–∑—Ä–∞–∫–æ–≤
                if (ghost.teleportCooldown <= 0 && Math.random() > 0.995) {
                    ghost.x = Math.random() * GRID_WIDTH;
                    ghost.y = Math.random() * GRID_HEIGHT;
                    ghost.teleportCooldown = 60;
                    showCrazyMessage("–ü–†–ò–ó–†–ê–ö –¢–ï–õ–ï–ü–û–†–¢–ò–†–û–í–ê–õ–°–Ø! üëª", ghost.x, ghost.y);
                }
                ghost.teleportCooldown--;
                
                // –ü–æ–≤–µ–¥–µ–Ω–∏–µ
                switch(ghost.behavior) {
                    case 'chase':
                        ghost.target.x = pacman.x;
                        ghost.target.y = pacman.y;
                        break;
                    case 'ambush':
                        ghost.target.x = pacman.x + pacman.direction.x * 100;
                        ghost.target.y = pacman.y + pacman.direction.y * 100;
                        break;
                    case 'random':
                        if (Math.random() > 0.98) {
                            ghost.target.x = Math.random() * GRID_WIDTH;
                            ghost.target.y = Math.random() * GRID_HEIGHT;
                        }
                        break;
                    case 'scatter':
                        ghost.target.x = Math.random() > 0.5 ? 0 : GRID_WIDTH;
                        ghost.target.y = Math.random() > 0.5 ? 0 : GRID_HEIGHT;
                        break;
                }
                
                // –î–≤–∏–∂–µ–Ω–∏–µ –∫ —Ü–µ–ª–∏ (–∏–Ω–æ–≥–¥–∞ –≤ –ø—Ä–æ—Ç–∏–≤–æ–ø–æ–ª–æ–∂–Ω—É—é —Å—Ç–æ—Ä–æ–Ω—É)
                let dx = ghost.target.x - ghost.x;
                let dy = ghost.target.y - ghost.y;
                const distance = Math.sqrt(dx * dx + dy * dy);
                
                if (distance > 0) {
                    if (Math.random() > 0.1) { // 10% —à–∞–Ω—Å –∏–¥—Ç–∏ –≤ –ø—Ä–æ—Ç–∏–≤–æ–ø–æ–ª–æ–∂–Ω—É—é —Å—Ç–æ—Ä–æ–Ω—É
                        ghost.direction.x = (dx / distance) * ghost.speed;
                        ghost.direction.y = (dy / distance) * ghost.speed;
                    } else {
                        ghost.direction.x = (-dx / distance) * ghost.speed;
                        ghost.direction.y = (-dy / distance) * ghost.speed;
                    }
                }
                
                // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–∑–∏—Ü–∏–∏
                ghost.x += ghost.direction.x;
                ghost.y += ghost.direction.y;
                
                // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–æ–ª–∫–Ω–æ–≤–µ–Ω–∏—è —Å –ü–∞–∫–º–∞–Ω–æ–º
                const distToPacman = Math.sqrt(
                    Math.pow(ghost.x - pacman.x, 2) + 
                    Math.pow(ghost.y - pacman.y, 2)
                );
                
                if (distToPacman < pacman.radius + ghost.radius) {
                    if (game.powerMode || pacman.invincible) {
                        // –ü–∞–∫–º–∞–Ω —Å—ä–µ–¥–∞–µ—Ç –ø—Ä–∏–∑—Ä–∞–∫–∞
                        game.score += 200;
                        ghost.x = Math.random() * GRID_WIDTH;
                        ghost.y = Math.random() * GRID_HEIGHT;
                        showCrazyMessage("–ù–û–ú-–ù–û–ú –ü–†–ò–ó–†–ê–ö! üëª", ghost.x, ghost.y);
                    } else {
                        // –ü—Ä–∏–∑—Ä–∞–∫ —Å—ä–µ–¥–∞–µ—Ç –ü–∞–∫–º–∞–Ω–∞
                        takeDamage(1);
                        ghost.x = Math.random() * GRID_WIDTH;
                        ghost.y = Math.random() * GRID_HEIGHT;
                    }
                }
                
                // –°—Ç—Ä–∞—à–Ω—ã–π —Ä–µ–∂–∏–º
                if (ghost.scared) {
                    ghost.scaredTimer--;
                    if (ghost.scaredTimer <= 0) {
                        ghost.scared = false;
                    }
                }
            });
        }

        function updateZombies() {
            zombies.forEach(zombie => {
                // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–∑–∏—Ü–∏–∏
                zombie.x += zombie.direction.x * zombie.speed;
                zombie.y += zombie.direction.y * zombie.speed;
                
                // –ù–µ–ª–æ–≥–∏—á–Ω—ã–π –æ—Ç—Å–∫–æ–∫ –æ—Ç —Å—Ç–µ–Ω
                const gridX = Math.floor(zombie.x / CELL_SIZE);
                const gridY = Math.floor(zombie.y / CELL_SIZE);
                
                if (gridX >= 0 && gridX < MAP_SIZE && gridY >= 0 && gridY < MAP_SIZE) {
                    if (game.map[gridY][gridX] === 1 || Math.random() > 0.95) {
                        // –ò–Ω–æ–≥–¥–∞ –æ—Ç—Å–∫–∞–∫–∏–≤–∞–µ—Ç, –∏–Ω–æ–≥–¥–∞ –ø—Ä–æ—Ö–æ–¥–∏—Ç —Å–∫–≤–æ–∑—å
                        if (Math.random() > 0.3) {
                            zombie.direction.x = -zombie.direction.x;
                            zombie.direction.y = -zombie.direction.y;
                            zombie.bounceCount++;
                            
                            // –ü–æ—Å–ª–µ 3 –æ—Ç—Å–∫–æ–∫–æ–≤ –º–µ–Ω—è–µ—Ç –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–ª—É—á–∞–π–Ω–æ
                            if (zombie.bounceCount > 3) {
                                zombie.direction.x = Math.random() * 2 - 1;
                                zombie.direction.y = Math.random() * 2 - 1;
                                zombie.bounceCount = 0;
                            }
                        }
                    }
                }
                
                // –¢–µ–ª–µ–ø–æ—Ä—Ç–∞—Ü–∏—è —á–µ—Ä–µ–∑ –∫—Ä–∞—è
                if (zombie.x < -zombie.radius) zombie.x = GRID_WIDTH + zombie.radius;
                if (zombie.x > GRID_WIDTH + zombie.radius) zombie.x = -zombie.radius;
                if (zombie.y < -zombie.radius) zombie.y = GRID_HEIGHT + zombie.radius;
                if (zombie.y > GRID_HEIGHT + zombie.radius) zombie.y = -zombie.radius;
                
                // –í—Ä–∞—â–µ–Ω–∏–µ
                zombie.rotation += 0.05;
                
                // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–æ–ª–∫–Ω–æ–≤–µ–Ω–∏—è —Å –ü–∞–∫–º–∞–Ω–æ–º
                const distToPacman = Math.sqrt(
                    Math.pow(zombie.x - pacman.x, 2) + 
                    Math.pow(zombie.y - pacman.y, 2)
                );
                
                if (distToPacman < pacman.radius + zombie.radius) {
                    takeDamage(2);
                    // –û—Ç—Ç–∞–ª–∫–∏–≤–∞–Ω–∏–µ
                    const angle = Math.atan2(pacman.y - zombie.y, pacman.x - zombie.x);
                    pacman.x += Math.cos(angle) * 50;
                    pacman.y += Math.sin(angle) * 50;
                    showCrazyMessage("–ó–û–ú–ë–ò-–®–ê–† –ê–¢–ê–ö–£–ï–¢! üíÄ", zombie.x, zombie.y);
                }
            });
        }

        function updateUFOs() {
            ufos.forEach(ufo => {
                // –î–≤–∏–∂–µ–Ω–∏–µ –ø–æ —Å–∏–Ω—É—Å–æ–∏–¥–µ
                ufo.x += ufo.direction.x * ufo.speed;
                ufo.y += Math.sin(Date.now() / 1000 + ufo.x / 100) * 3;
                
                // –ü–æ–≤–æ—Ä–æ—Ç
                ufo.rotation += 0.02;
                
                // –õ—É—á
                if (ufo.beamActive) {
                    ufo.beamTimer--;
                    if (ufo.beamTimer <= 0) {
                        ufo.beamActive = false;
                    }
                } else if (Math.random() > 0.995) {
                    ufo.beamActive = true;
                    ufo.beamTimer = 60;
                    ufo.abductionTarget = { x: pacman.x, y: pacman.y };
                }
                
                // –ì—Ä–∞–≤–∏—Ç–∞—Ü–∏–æ–Ω–Ω–æ–µ –ø–æ–ª–µ
                const distToPacman = Math.sqrt(
                    Math.pow(ufo.x - pacman.x, 2) + 
                    Math.pow(ufo.y - pacman.y, 2)
                );
                
                if (distToPacman < ufo.gravityField) {
                    // –ü—Ä–∏—Ç—è–≥–∏–≤–∞–µ—Ç –∏–ª–∏ –æ—Ç—Ç–∞–ª–∫–∏–≤–∞–µ—Ç –ü–∞–∫–º–∞–Ω–∞
                    const force = (ufo.gravityField - distToPacman) / ufo.gravityField * 2;
                    const angle = Math.atan2(ufo.y - pacman.y, ufo.x - pacman.x);
                    
                    if (game.gravityReversed) {
                        pacman.x += Math.cos(angle) * force;
                        pacman.y += Math.sin(angle) * force;
                    } else {
                        pacman.x -= Math.cos(angle) * force;
                        pacman.y -= Math.sin(angle) * force;
                    }
                }
                
                // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª—É—á–∞
                if (ufo.beamActive && ufo.abductionTarget) {
                    const beamDist = Math.sqrt(
                        Math.pow(ufo.x - pacman.x, 2) + 
                        Math.pow(ufo.y - pacman.y, 2)
                    );
                    
                    if (beamDist < 100) {
                        // –¢–µ–ª–µ–ø–æ—Ä—Ç–∞—Ü–∏—è –ü–∞–∫–º–∞–Ω–∞
                        pacman.x = Math.random() * GRID_WIDTH;
                        pacman.y = Math.random() * GRID_HEIGHT;
                        showCrazyMessage("–ü–û–•–ò–©–ï–ù –ù–õ–û! üõ∏", ufo.x, ufo.y);
                        ufo.beamActive = false;
                    }
                }
            });
        }

        function updateParticles() {
            particles = particles.filter(particle => particle.update());
        }

        function updateCrazyMessages() {
            crazyMessages = crazyMessages.filter(msg => {
                msg.y -= 2;
                msg.life--;
                return msg.life > 0;
            });
        }

        function takeDamage(amount) {
            if (pacman.invincible) return;
            
            game.lives -= amount;
            game.rage = Math.min(100, game.rage + 10);
            rageFill.style.width = `${game.rage}%`;
            
            // –≠—Ñ—Ñ–µ–∫—Ç –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–∏—è
            for (let i = 0; i < 20; i++) {
                particles.push(new Particle(pacman.x, pacman.y, '#FF0000'));
            }
            
            // –ú–∏–≥–∞–Ω–∏–µ
            pacman.invincible = true;
            pacman.invincibleTimer = 60;
            
            // –í–∏–∑—É–∞–ª—å–Ω—ã–π —ç—Ñ—Ñ–µ–∫—Ç
            showCrazyMessage("–ê–ô! –ë–û–õ–¨–ù–û! üò´", pacman.x, pacman.y);
            
            if (game.lives <= 0) {
                endGame();
            }
            
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∂–∏–∑–Ω–µ–π
            updateLivesDisplay();
        }

        function applyPowerUp(powerUp) {
            game.score += 100;
            
            switch(powerUp.type) {
                case 'speed':
                    pacman.speed *= 1.5;
                    setTimeout(() => pacman.speed /= 1.5, powerUp.duration);
                    showCrazyMessage("–°–£–ü–ï–† –°–ö–û–†–û–°–¢–¨! ‚ö°", powerUp.x, powerUp.y);
                    break;
                    
                case 'invincible':
                    pacman.invincible = true;
                    pacman.invincibleTimer = powerUp.duration;
                    showCrazyMessage("–ù–ï–£–Ø–ó–í–ò–ú–û–°–¢–¨! üõ°Ô∏è", powerUp.x, powerUp.y);
                    break;
                    
                case 'magnet':
                    // –ü—Ä–∏—Ç—è–≥–∏–≤–∞–µ—Ç –≤—Å–µ —Ç–æ—á–∫–∏
                    showCrazyMessage("–ú–ê–ì–ù–ò–¢ –î–õ–Ø –¢–û–ß–ï–ö! üß≤", powerUp.x, powerUp.y);
                    break;
                    
                case 'confuse':
                    // –ü—É—Ç–∞–µ—Ç –≤—Ä–∞–≥–æ–≤
                    ghosts.forEach(ghost => {
                        ghost.direction.x = -ghost.direction.x;
                        ghost.direction.y = -ghost.direction.y;
                    });
                    showCrazyMessage("–í–†–ê–ì–ò –ó–ê–ü–£–¢–ê–õ–ò–°–¨! üåÄ", powerUp.x, powerUp.y);
                    break;
                    
                case 'time':
                    // –ó–∞–º–µ–¥–ª—è–µ—Ç –≤—Ä–µ–º—è –¥–ª—è –≤—Ä–∞–≥–æ–≤
                    showCrazyMessage("–í–†–ï–ú–Ø –ó–ê–ú–ï–î–õ–ò–õ–û–°–¨! ‚è≥", powerUp.x, powerUp.y);
                    break;
            }
            
            // –ß–∞—Å—Ç–∏—Ü—ã
            for (let i = 0; i < 15; i++) {
                particles.push(new Particle(powerUp.x, powerUp.y, powerUp.color));
            }
        }

        function triggerCrazyEvent() {
            const events = [
                () => {
                    // –ò–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —ç–∫—Ä–∞–Ω–∞
                    canvas.style.filter = 'invert(1)';
                    setTimeout(() => canvas.style.filter = '', 3000);
                    showCrazyMessage("–≠–ö–†–ê–ù –ü–ï–†–ï–í–ï–†–ù–£–õ–°–Ø! üì∫", canvas.width/2, canvas.height/2);
                },
                () => {
                    // –°–ª—É—á–∞–π–Ω–∞—è —Ç–µ–ª–µ–ø–æ—Ä—Ç–∞—Ü–∏—è –≤—Å–µ—Ö
                    teleportRandom();
                    showCrazyMessage("–í–°–ï –¢–ï–õ–ï–ü–û–†–¢–ò–†–û–í–ê–õ–ò–°–¨! üåÄ", canvas.width/2, canvas.height/2);
                },
                () => {
                    // –í—Å–µ –≤—Ä–∞–≥–∏ —Å—Ç–∞–Ω–æ–≤—è—Ç—Å—è –≥–∏–≥–∞–Ω—Ç—Å–∫–∏–º–∏
                    ghosts.forEach(g => g.radius *= 2);
                    zombies.forEach(z => z.radius *= 2);
                    setTimeout(() => {
                        ghosts.forEach(g => g.radius /= 2);
                        zombies.forEach(z => z.radius /= 2);
                    }, 5000);
                    showCrazyMessage("–ì–ò–ì–ê–ù–¢–°–ö–ò–ï –í–†–ê–ì–ò! üëπ", canvas.width/2, canvas.height/2);
                },
                () => {
                    // –í—Å–µ —Å—Ç–µ–Ω—ã –∏—Å—á–µ–∑–∞—é—Ç
                    showCrazyMessage("–°–¢–ï–ù–´ –ò–°–ß–ï–ó–õ–ò! üß±", canvas.width/2, canvas.height/2);
                },
                () => {
                    // –ü–∞–∫–º–∞–Ω –º–µ–Ω—è–µ—Ç —Ü–≤–µ—Ç
                    const oldColor = pacman.color;
                    pacman.color = `hsl(${Math.random() * 360}, 100%, 50%)`;
                    setTimeout(() => pacman.color = oldColor, 5000);
                    showCrazyMessage("–Ø –†–ê–ó–ù–û–¶–í–ï–¢–ù–´–ô! üåà", pacman.x, pacman.y);
                }
            ];
            
            events[Math.floor(Math.random() * events.length)]();
            game.insanity = Math.min(100, game.insanity + 10);
        }

        function teleportRandom() {
            pacman.x = Math.random() * GRID_WIDTH;
            pacman.y = Math.random() * GRID_HEIGHT;
            createTeleportEffect(pacman.x, pacman.y);
        }

        function createTeleportEffect(x, y) {
            const effect = document.createElement('div');
            effect.className = 'teleport-effect';
            effect.style.left = `${x - 50}px`;
            effect.style.top = `${y - 50}px`;
            document.getElementById('gameContainer').appendChild(effect);
            
            setTimeout(() => effect.remove(), 1000);
        }

        function showCrazyMessage(text, x, y) {
            crazyMessages.push({
                text: text,
                x: x,
                y: y,
                life: 100
            });
        }

        function updateLivesDisplay() {
            let hearts = '';
            for (let i = 0; i < game.lives; i++) {
                hearts += '‚ù§Ô∏è';
            }
            livesElement.textContent = `–ñ–ò–ó–ù–ò: ${hearts}`;
        }

        function updateUI() {
            scoreElement.textContent = `–°–ß–Å–¢: ${game.score}`;
            levelElement.textContent = `–£–†–û–í–ï–ù–¨ –ë–ï–ó–£–ú–ò–Ø: ${game.level}`;
            insanityLevel.textContent = `–ë–ï–ó–£–ú–ò–ï: ${Math.floor(game.insanity)}%`;
            
            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–æ–≤—ã—à–µ–Ω–∏–µ —É—Ä–æ–≤–Ω—è –ø—Ä–∏ —Å–±–æ—Ä–µ –≤—Å–µ—Ö —Ç–æ—á–µ–∫
            if (game.dotsCollected >= game.totalDots) {
                game.level++;
                game.dotsCollected = 0;
                initMap();
                showCrazyMessage(`–£–†–û–í–ï–ù–¨ ${game.level}! üéâ`, pacman.x, pacman.y);
            }
            
            // –®–∫–∞–ª–∞ —è—Ä–æ—Å—Ç–∏
            if (game.rage >= 100) {
                endGame();
            }
        }

        function drawMap() {
            // –†–∏—Å—É–µ–º –∫–∞—Ä—Ç—É
            for (let y = 0; y < MAP_SIZE; y++) {
                for (let x = 0; x < MAP_SIZE; x++) {
                    const screenX = x * CELL_SIZE - game.cameraX;
                    const screenY = y * CELL_SIZE - game.cameraY;
                    
                    // –¢–æ–ª—å–∫–æ –≤–∏–¥–∏–º—ã–µ –∫–ª–µ—Ç–∫–∏
                    if (screenX + CELL_SIZE > 0 && screenX < canvas.width &&
                        screenY + CELL_SIZE > 0 && screenY < canvas.height) {
                        
                        if (game.map[y][x] === 1) {
                            // –°—Ç–µ–Ω—ã
                            ctx.fillStyle = '#1E90FF';
                            ctx.fillRect(screenX, screenY, CELL_SIZE, CELL_SIZE);
                            
                            // –¢–µ–∫—Å—Ç—É—Ä–∞ —Å—Ç–µ–Ω
                            ctx.strokeStyle = '#00BFFF';
                            ctx.lineWidth = 2;
                            ctx.strokeRect(screenX, screenY, CELL_SIZE, CELL_SIZE);
                        } else {
                            // –ü–æ–ª
                            ctx.fillStyle = '#000';
                            ctx.fillRect(screenX, screenY, CELL_SIZE, CELL_SIZE);
                        }
                    }
                }
            }
            
            // –¢–æ—á–∫–∏
            dots.forEach(dot => {
                if (!dot.collected) {
                    const screenX = dot.x - game.cameraX;
                    const screenY = dot.y - game.cameraY;
                    
                    if (dot.blinking) {
                        ctx.globalAlpha = 0.5 + Math.sin(Date.now() / 200) * 0.5;
                    }
                    
                    ctx.fillStyle = dot.color;
                    ctx.beginPath();
                    ctx.arc(screenX, screenY, dot.radius, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.globalAlpha = 1;
                }
            });
            
            // –≠–Ω–µ—Ä–¥–∂–∞–π–∑–µ—Ä—ã
            energizers.forEach(energizer => {
                if (!energizer.collected) {
                    const screenX = energizer.x - game.cameraX;
                    const screenY = energizer.y - game.cameraY;
                    
                    energizer.pulse += 0.1;
                    const pulseSize = energizer.radius + Math.sin(energizer.pulse) * 5;
                    
                    ctx.fillStyle = energizer.color;
                    ctx.beginPath();
                    ctx.arc(screenX, screenY, pulseSize, 0, Math.PI * 2);
                    ctx.fill();
                    
                    // –°–≤–µ—á–µ–Ω–∏–µ
                    ctx.shadowColor = energizer.color;
                    ctx.shadowBlur = 20;
                    ctx.beginPath();
                    ctx.arc(screenX, screenY, pulseSize, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.shadowBlur = 0;
                }
            });
            
            // –ü–æ—Ä—Ç–∞–ª—ã
            portals.forEach(portal => {
                if (portal.active) {
                    const screenX = portal.x - game.cameraX;
                    const screenY = portal.y - game.cameraY;
                    
                    ctx.strokeStyle = portal.color;
                    ctx.lineWidth = 5;
                    ctx.beginPath();
                    ctx.arc(screenX, screenY, portal.radius, 0, Math.PI * 2);
                    ctx.stroke();
                    
                    // –í—Ä–∞—â–µ–Ω–∏–µ
                    ctx.save();
                    ctx.translate(screenX, screenY);
                    ctx.rotate(Date.now() / 1000);
                    ctx.strokeStyle = '#00FFFF';
                    ctx.beginPath();
                    for (let i = 0; i < 8; i++) {
                        const angle = (i / 8) * Math.PI * 2;
                        const x1 = Math.cos(angle) * portal.radius;
                        const y1 = Math.sin(angle) * portal.radius;
                        const x2 = Math.cos(angle) * (portal.radius - 10);
                        const y2 = Math.sin(angle) * (portal.radius - 10);
                        ctx.moveTo(x1, y1);
                        ctx.lineTo(x2, y2);
                    }
                    ctx.stroke();
                    ctx.restore();
                }
            });
        }

        function drawPacman() {
            const screenX = pacman.x - game.cameraX;
            const screenY = pacman.y - game.cameraY;
            
            // –°–ª–µ–¥
            ctx.strokeStyle = 'rgba(255, 255, 0, 0.3)';
            ctx.lineWidth = 5;
            ctx.beginPath();
            pacman.trail.forEach((point, i) => {
                const trailX = point.x - game.cameraX;
                const trailY = point.y - game.cameraY;
                if (i === 0) ctx.moveTo(trailX, trailY);
                else ctx.lineTo(trailX, trailY);
            });
            ctx.stroke();
            
            // –¢–µ–ª–æ –ü–∞–∫–º–∞–Ω–∞
            ctx.save();
            ctx.translate(screenX, screenY);
            
            // –ú–∏–≥–∞–Ω–∏–µ –ø—Ä–∏ –Ω–µ—É—è–∑–≤–∏–º–æ—Å—Ç–∏
            if (pacman.invincible && Math.floor(Date.now() / 100) % 2 === 0) {
                ctx.globalAlpha = 0.5;
            }
            
            // –†–æ—Ç
            ctx.fillStyle = pacman.color;
            ctx.beginPath();
            ctx.moveTo(0, 0);
            ctx.arc(0, 0, pacman.radius, pacman.mouthAngle, Math.PI * 2 - pacman.mouthAngle);
            ctx.closePath();
            ctx.fill();
            
            // –ì–ª–∞–∑
            ctx.fillStyle = '#000';
            ctx.beginPath();
            ctx.arc(pacman.radius * 0.3, -pacman.radius * 0.3, pacman.radius * 0.2, 0, Math.PI * 2);
            ctx.fill();
            
            ctx.restore();
        }

        function drawGhosts() {
            ghosts.forEach(ghost => {
                const screenX = ghost.x - game.cameraX;
                const screenY = ghost.y - game.cameraY;
                
                ctx.save();
                ctx.translate(screenX, screenY);
                
                // –¢–µ–ª–æ
                ctx.fillStyle = ghost.scared ? '#0000FF' : ghost.color;
                ctx.beginPath();
                ctx.arc(0, 0, ghost.radius, 0, Math.PI * 2);
                ctx.fill();
                
                // –ì–ª–∞–∑–∞
                ctx.fillStyle = '#FFFFFF';
                ctx.beginPath();
                ctx.arc(-ghost.radius * 0.3, -ghost.radius * 0.3, ghost.radius * 0.3, 0, Math.PI * 2);
                ctx.arc(ghost.radius * 0.3, -ghost.radius * 0.3, ghost.radius * 0.3, 0, Math.PI * 2);
                ctx.fill();
                
                // –ó—Ä–∞—á–∫–∏
                ctx.fillStyle = '#0000FF';
                const lookX = pacman.x - ghost.x;
                const lookY = pacman.y - ghost.y;
                const angle = Math.atan2(lookY, lookX);
                ctx.beginPath();
                ctx.arc(
                    -ghost.radius * 0.3 + Math.cos(angle) * 5,
                    -ghost.radius * 0.3 + Math.sin(angle) * 5,
                    ghost.radius * 0.15,
                    0,
                    Math.PI * 2
                );
                ctx.arc(
                    ghost.radius * 0.3 + Math.cos(angle) * 5,
                    -ghost.radius * 0.3 + Math.sin(angle) * 5,
                    ghost.radius * 0.15,
                    0,
                    Math.PI * 2
                );
                ctx.fill();
                
                // –ò–º—è –ø—Ä–∏–∑—Ä–∞–∫–∞
                ctx.fillStyle = '#FFFFFF';
                ctx.font = '12px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(ghost.name, 0, ghost.radius + 15);
                
                ctx.restore();
            });
        }

        function drawZombies() {
            zombies.forEach(zombie => {
                const screenX = zombie.x - game.cameraX;
                const screenY = zombie.y - game.cameraY;
                
                ctx.save();
                ctx.translate(screenX, screenY);
                ctx.rotate(zombie.rotation);
                
                // –¢–µ–ª–æ –∑–æ–º–±–∏-—à–∞—Ä–∞
                ctx.fillStyle = zombie.color;
                ctx.beginPath();
                ctx.arc(0, 0, zombie.radius, 0, Math.PI * 2);
                ctx.fill();
                
                // –õ–∏—Ü–æ –∑–æ–º–±–∏
                ctx.fillStyle = '#000';
                ctx.font = `${zombie.radius}px Arial`;
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(zombie.face, 0, 0);
                
                // –ö—Ä–æ–≤–∞–≤—ã–µ —Å–ª–µ–¥—ã
                ctx.strokeStyle = '#8B0000';
                ctx.lineWidth = 3;
                ctx.beginPath();
                for (let i = 0; i < 8; i++) {
                    const angle = (i / 8) * Math.PI * 2;
                    const x = Math.cos(angle) * zombie.radius;
                    const y = Math.sin(angle) * zombie.radius;
                    ctx.moveTo(x, y);
                    ctx.lineTo(x * 1.5, y * 1.5);
                }
                ctx.stroke();
                
                ctx.restore();
            });
        }

        function drawUFOs() {
            ufos.forEach(ufo => {
                const screenX = ufo.x - game.cameraX;
                const screenY = ufo.y - game.cameraY;
                
                ctx.save();
                ctx.translate(screenX, screenY);
                ctx.rotate(ufo.rotation);
                
                // –ö–æ—Ä–ø—É—Å –ù–õ–û
                ctx.fillStyle = ufo.color;
                ctx.beginPath();
                ctx.arc(0, 0, ufo.radius, 0, Math.PI * 2);
                ctx.fill();
                
                // –ö—É–ø–æ–ª
                ctx.fillStyle = '#00FFFF';
                ctx.beginPath();
                ctx.arc(0, 0, ufo.radius * 0.7, 0, Math.PI * 2);
                ctx.fill();
                
                // –û–≥–Ω–∏
                ctx.fillStyle = '#FFFF00';
                for (let i = 0; i < 6; i++) {
                    const angle = (i / 6) * Math.PI * 2;
                    const x = Math.cos(angle) * ufo.radius * 0.8;
                    const y = Math.sin(angle) * ufo.radius * 0.8;
                    ctx.beginPath();
                    ctx.arc(x, y, ufo.radius * 0.2, 0, Math.PI * 2);
                    ctx.fill();
                }
                
                // –õ—É—á
                if (ufo.beamActive) {
                    ctx.fillStyle = 'rgba(0, 255, 255, 0.3)';
                    ctx.beginPath();
                    ctx.moveTo(0, ufo.radius);
                    ctx.lineTo(-50, canvas.height);
                    ctx.lineTo(50, canvas.height);
                    ctx.closePath();
                    ctx.fill();
                }
                
                ctx.restore();
            });
        }

        function drawPowerUps() {
            powerUps.forEach(powerUp => {
                if (!powerUp.collected) {
                    const screenX = powerUp.x - game.cameraX;
                    const screenY = powerUp.y - game.cameraY;
                    
                    ctx.save();
                    ctx.translate(screenX, screenY);
                    
                    // –í—Ä–∞—â–µ–Ω–∏–µ
                    powerUp.rotation += 0.05;
                    ctx.rotate(powerUp.rotation);
                    
                    // –û—Å–Ω–æ–≤–∞
                    ctx.fillStyle = powerUp.color;
                    ctx.beginPath();
                    ctx.arc(0, 0, powerUp.radius, 0, Math.PI * 2);
                    ctx.fill();
                    
                    // –°–∏–º–≤–æ–ª
                    ctx.fillStyle = '#FFFFFF';
                    ctx.font = '24px Arial';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText(powerUp.symbol, 0, 0);
                    
                    ctx.restore();
                }
            });
        }

        function drawParticles() {
            particles.forEach(particle => particle.draw());
        }

        function drawCrazyMessages() {
            crazyMessages.forEach(msg => {
                const screenX = msg.x - game.cameraX;
                const screenY = msg.y - game.cameraY;
                
                ctx.fillStyle = '#FFFF00';
                ctx.font = '24px Comic Sans MS';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(msg.text, screenX, screenY);
            });
        }

        function drawMapIndicator() {
            mapCtx.clearRect(0, 0, 200, 200);
            
            // –§–æ–Ω –º–∏–Ω–∏-–∫–∞—Ä—Ç—ã
            mapCtx.fillStyle = '#000';
            mapCtx.fillRect(0, 0, 200, 200);
            
            // –ì—Ä–∞–Ω–∏—Ü—ã
            mapCtx.strokeStyle = '#00FFFF';
            mapCtx.lineWidth = 3;
            mapCtx.strokeRect(0, 0, 200, 200);
            
            // –ú–∞—Å—à—Ç–∞–± –¥–ª—è –º–∏–Ω–∏-–∫–∞—Ä—Ç—ã
            const scaleX = 200 / GRID_WIDTH;
            const scaleY = 200 / GRID_HEIGHT;
            
            // –ü–∞–∫–º–∞–Ω –Ω–∞ –∫–∞—Ä—Ç–µ
            const pacmanX = pacman.x * scaleX;
            const pacmanY = pacman.y * scaleY;
            
            mapCtx.fillStyle = '#FFFF00';
            mapCtx.beginPath();
            mapCtx.arc(pacmanX, pacmanY, 5, 0, Math.PI * 2);
            mapCtx.fill();
            
            // –í—Ä–∞–≥–∏ –Ω–∞ –∫–∞—Ä—Ç–µ
            ghosts.forEach(ghost => {
                mapCtx.fillStyle = ghost.scared ? '#0000FF' : ghost.color;
                mapCtx.beginPath();
                mapCtx.arc(ghost.x * scaleX, ghost.y * scaleY, 3, 0, Math.PI * 2);
                mapCtx.fill();
            });
        }

        function gameLoop() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            if (game.running && !game.gameOver) {
                // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Å–µ –æ–±—ä–µ–∫—Ç—ã
                updatePacman();
                updateGhosts();
                updateZombies();
                updateUFOs();
                updateParticles();
                updateCrazyMessages();
                updateUI();
                
                // –†–∏—Å—É–µ–º –≤—Å–µ –æ–±—ä–µ–∫—Ç—ã
                drawMap();
                drawPacman();
                drawGhosts();
                drawZombies();
                drawUFOs();
                drawPowerUps();
                drawParticles();
                drawCrazyMessages();
                drawMapIndicator();
                
                // –≠—Ñ—Ñ–µ–∫—Ç—ã –Ω–∞ –≤—ã—Å–æ–∫–æ–º —É—Ä–æ–≤–Ω–µ –±–µ–∑—É–º–∏—è
                if (game.insanity > 70) {
                    ctx.save();
                    ctx.globalAlpha = 0.1;
                    ctx.fillStyle = `hsl(${Math.random() * 360}, 100%, 50%)`;
                    ctx.fillRect(0, 0, canvas.width, canvas.height);
                    ctx.restore();
                    
                    // –î—Ä–æ–∂–∞–Ω–∏–µ —ç–∫—Ä–∞–Ω–∞
                    if (Math.random() > 0.7) {
                        canvas.style.transform = `translate(${Math.random() * 10 - 5}px, ${Math.random() * 10 - 5}px)`;
                    }
                }
            }
            
            requestAnimationFrame(gameLoop);
        }

        function startGame() {
            game.running = true;
            game.gameOver = false;
            game.score = 0;
            game.lives = 3;
            game.level = 1;
            game.rage = 0;
            game.insanity = 0;
            game.powerMode = false;
            game.gravityReversed = false;
            game.controlsReversed = false;
            game.dotsCollected = 0;
            
            pacman.x = GRID_WIDTH / 2;
            pacman.y = GRID_HEIGHT / 2;
            pacman.direction.x = 0;
            pacman.direction.y = 0;
            pacman.trail = [];
            pacman.invincible = false;
            
            initMap();
            updateLivesDisplay();
            startScreen.style.display = 'none';
            gameOverScreen.style.display = 'none';
            canvas.style.transform = 'none';
            canvas.style.filter = 'none';
        }

        function endGame() {
            game.running = false;
            game.gameOver = true;
            
            finalScoreElement.textContent = game.score;
            finalInsanityElement.textContent = `${Math.floor(game.insanity)}%`;
            gameOverScreen.style.display = 'block';
            
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ Telegram
            if (typeof Telegram !== 'undefined') {
                Telegram.WebApp.sendData(JSON.stringify({
                    score: game.score,
                    level: game.level,
                    insanity: Math.floor(game.insanity),
                    rage: game.rage
                }));
            }
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
        startBtn.addEventListener('click', startGame);
        restartBtn.addEventListener('click', startGame);

        // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ü–∞–∫–º–∞–Ω–æ–º
        const setDirection = (dx, dy) => {
            pacman.direction.x = dx;
            pacman.direction.y = dy;
        };

        upBtn.addEventListener('click', () => setDirection(0, -1));
        downBtn.addEventListener('click', () => setDirection(0, 1));
        leftBtn.addEventListener('click', () => setDirection(-1, 0));
        rightBtn.addEventListener('click', () => setDirection(1, 0));

        powerBtn.addEventListener('click', () => {
            if (game.running) {
                // –ê–∫—Ç–∏–≤–∞—Ü–∏—è —Å–ª—É—á–∞–π–Ω–æ–≥–æ –ø–∞–≤–µ—Ä-–∞–ø–∞
                const randomEffect = Math.random();
                if (randomEffect < 0.2) {
                    game.powerMode = true;
                    game.powerTimer = 150;
                    showCrazyMessage("–†–ï–ñ–ò–ú –°–ò–õ–´! üí™", pacman.x, pacman.y);
                } else if (randomEffect < 0.4) {
                    teleportRandom();
                    showCrazyMessage("–¢–ï–õ–ï–ü–û–†–¢! üåÄ", pacman.x, pacman.y);
                } else if (randomEffect < 0.6) {
                    ghosts.forEach(g => g.scared = true);
                    showCrazyMessage("–ü–†–ò–ó–†–ê–ö–ò –ò–°–ü–£–ì–ê–ù–´! üëª", pacman.x, pacman.y);
                }
            }
        });

        // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–ª–∞–≤–∏–∞—Ç—É—Ä–æ–π
        document.addEventListener('keydown', (e) => {
            if (!game.running) return;
            
            switch(e.code) {
                case 'ArrowUp':
                case 'KeyW':
                    e.preventDefault();
                    setDirection(0, -1);
                    break;
                    
                case 'ArrowDown':
                case 'KeyS':
                    e.preventDefault();
                    setDirection(0, 1);
                    break;
                    
                case 'ArrowLeft':
                case 'KeyA':
                    e.preventDefault();
                    setDirection(-1, 0);
                    break;
                    
                case 'ArrowRight':
                case 'KeyD':
                    e.preventDefault();
                    setDirection(1, 0);
                    break;
                    
                case 'Space':
                case 'KeyP':
                    e.preventDefault();
                    powerBtn.click();
                    break;
            }
        });

        // –°–≤–∞–π–ø—ã –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö
        let touchStartX = 0;
        let touchStartY = 0;
        
        canvas.addEventListener('touchstart', (e) => {
            e.preventDefault();
            touchStartX = e.touches[0].clientX;
            touchStartY = e.touches[0].clientY;
        });

        canvas.addEventListener('touchend', (e) => {
            if (!game.running) return;
            
            const touchEndX = e.changedTouches[0].clientX;
            const touchEndY = e.changedTouches[0].clientY;
            
            const deltaX = touchEndX - touchStartX;
            const deltaY = touchEndY - touchStartY;
            
            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–≤–∞–π–ø–∞
            if (Math.abs(deltaX) > Math.abs(deltaY)) {
                // –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–π —Å–≤–∞–π–ø
                if (deltaX > 30) setDirection(1, 0);  // –í–ø—Ä–∞–≤–æ
                else if (deltaX < -30) setDirection(-1, 0); // –í–ª–µ–≤–æ
            } else {
                // –í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–π —Å–≤–∞–π–ø
                if (deltaY > 30) setDirection(0, 1);  // –í–Ω–∏–∑
                else if (deltaY < -30) setDirection(0, -1); // –í–≤–µ—Ä—Ö
            }
        });

        // –î–≤–æ–π–Ω–æ–π —Ç–∞–ø –¥–ª—è –ø–∞–≤–µ—Ä-–∞–ø–∞
        let lastTap = 0;
        canvas.addEventListener('touchend', (e) => {
            const currentTime = new Date().getTime();
            const tapLength = currentTime - lastTap;
            
            if (tapLength < 300 && tapLength > 0) {
                powerBtn.click();
            }
            
            lastTap = currentTime;
        });

        // –ê–¥–∞–ø—Ç–∞—Ü–∏—è —Ä–∞–∑–º–µ—Ä–∞
        window.addEventListener('resize', () => {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        });

        // –ó–∞–ø—É—Å–∫–∞–µ–º –∏–≥—Ä—É
        gameLoop();
    </script>
</body>
</html>
